üíº Functional Design Document (FDD)

Project: Personal Finance Management System
Version: V1
Primary Stack: Django (Python), PostgreSQL, TailwindCSS, Vanilla JS (Ajax)
Mode: Self-hosted (Docker)
Default Theme: Dark (with light toggle)
Authoring Date: November 2025

1. Overview
   1.1 Purpose

The purpose of this system is to provide users with a self-hosted, secure, and intuitive personal finance management platform to record, categorize, and analyze their financial transactions across multiple accounts (bank, credit card, wallet, cash, FDs, loans, and investments).

It will help users:

Consolidate financial information in one place.

Track income, expenses, and transfers.

Monitor account balances and net worth.

Maintain investment and fixed deposit records.

Generate analytical reports to visualize financial patterns.

2. System Scope
   2.1 Functional Modules (V1)

| Module                     | Description                                                         |
| -------------------------- | ------------------------------------------------------------------- |
| Authentication             | Email/password login & signup with session management.              |
| User Profile & Preferences | Manage user profile, theme preference, and masking settings.        |
| Accounts                   | Create/manage accounts (bank, credit card, wallet, cash, FD, loan). |
| Transactions               | Record, view, and manage credit/debit entries per account.          |
| Transfers                  | Move money between user-owned accounts.                             |
| Categories                 | Maintain and manage categorized expense/income classification.      |
| Investments                | Manage stocks and mutual fund holdings, trades, and instruments.    |
| Fixed Deposits             | Record FD details and maturity info.                                |
| Loans                      | Record loan details and manual repayments.                          |
| Dashboard                  | Summarized analytics and KPIs.                                      |
| Reports                    | Income vs Expense, Spend by Category, Net Worth, Holdings Snapshot. |
| Activity Log               | Track user actions (create/update/delete).                          |
| Settings                   | Preferences, password change, and session management.               |

3. User Roles & Permissions
   3.1 Roles

User:
Can access, create, and manage only their own data.

Admin (system-level, optional later):
Has visibility into all users‚Äô data for debugging (disabled by default in V1).

3.2 Permissions Matrix (Simplified)

| Module       | User Permissions        | Admin Permissions (future) |
| ------------ | ----------------------- | -------------------------- |
| Accounts     | CRUD own accounts       | CRUD all                   |
| Transactions | CRUD own transactions   | CRUD all                   |
| Investments  | CRUD own investments    | CRUD all                   |
| Categories   | View default / CRUD own | Manage defaults            |
| Reports      | View only               | View all                   |
| Settings     | Update own              | Update global defaults     |

4. Core Functional Requirements
   4.1 Authentication

Login:

Email + Password form.

Validate against stored hash.

2-week session timeout (configurable).

Signup:

Create new user record.

No email verification.

Logout:

Ends current session.

Password Change:

Allowed via Settings > Security.

Validation:

Password ‚â• 8 chars, no strict complexity.

4.2 Accounts Module
Description

Manages all financial accounts where money can flow in or out. The system uses specialized apps for each account type to provide type-specific features and better organization.

Account Types and Apps

The system supports the following account types, each in its dedicated app:

1. **Savings Accounts** (`accounts/`) - Traditional bank accounts
2. **Credit Cards** (`creditcards/`) - Credit card accounts with billing cycles
3. **Digital Wallets** (`wallets/`) - UPI apps and mobile wallets
4. **Cash** (`cash/`) - Physical cash holdings
5. **Fixed Deposits** (`fds/`) - FD accounts with maturity tracking
6. **Loan Accounts** (`loans/`) - Loan tracking with EMI management

### 4.2.1 Savings Accounts

Traditional bank savings and checking accounts.

**Fields:**

| Field                   | Type           | Notes                            |
| ----------------------- | -------------- | -------------------------------- |
| Name / Nickname         | Text           | Display name                     |
| Subtype                 | Enum           | Savings / Checking / Salary      |
| Institution             | Text           | Bank name                        |
| Branch Name             | Text           | Optional                         |
| IFSC Code               | String         | 11-character IFSC code, optional |
| Account Number          | Encrypted Text | Full account number (encrypted)  |
| Account Number (Last 4) | String         | Last 4 digits for display        |
| Customer ID             | String         | Optional                         |
| Opening Balance         | Decimal        | Initial balance                  |
| Currency                | INR (fixed)    | ‚Äî                                |
| Opened On               | Date           | Account opening date             |
| Status                  | Enum           | Active / Archived                |
| Notes                   | Text           | Optional                         |
| Color                   | Hex Code       | Visual customization             |
| Picture                 | Image          | Optional icon/picture            |

**Actions:**

- Add/Edit/Delete savings account
- View current balance (materialized from ledger)
- View account detail & linked transactions
- Mask account number (show last 4 digits only)
- Archive (soft delete)

### 4.2.2 Debit Cards

Debit cards associated with bank accounts. They act as "payment methods" and share the balance of the linked bank account.

**Fields:**

| Field                   | Type           | Notes                                      |
| ----------------------- | -------------- | ------------------------------------------ |
| Name / Nickname         | Text           | Display name                               |
| Associated Bank Account | FK             | Linked bank account (Required)             |
| Card Number             | Encrypted Text | Full card number (encrypted, 12-19 digits) |
| Card Number (Last 4)    | String         | Auto-extracted for display                 |
| CVV                     | Encrypted Text | Card CVV (encrypted, 3-4 digits)           |
| Card Type               | Enum           | Visa / Mastercard / RuPay / Amex / Other   |
| Expiry Date             | Date           | Card expiry date                           |
| Status                  | Enum           | Active / Archived                          |
| Notes                   | Text           | Optional                                   |
| Color                   | Hex Code       | Visual customization                       |
| Picture                 | Image          | Optional logo                              |

**Actions:**

- Add/Edit/Delete debit card
- View linked bank account balance
- Mask card number (show last 4 digits only)
- Copy card number and CVV to clipboard
- View transactions associated with the debit card (via the Transaction model)

### 4.2.3 Credit Cards

Credit card accounts with billing cycles and credit limits.

**Fields:**

| Field                | Type           | Notes                                                               |
| -------------------- | -------------- | ------------------------------------------------------------------- |
| Name / Nickname      | Text           | Card display name                                                   |
| Institution          | Text           | Issuing bank (stored as-is, no auto-capitalization)                 |
| Card Number          | Encrypted Text | Full card number (encrypted, 13-19 digits)                          |
| Card Number (Last 4) | String         | Last 4 digits for display                                           |
| CVV                  | Encrypted Text | Card CVV (encrypted, 3-4 digits)                                    |
| Card Type            | Enum           | Visa / Mastercard / RuPay / Amex                                    |
| Credit Limit         | Decimal        | **Required** - Total credit limit                                   |
| Billing Day          | Integer        | **Required** - Day of month (1-31)                                  |
| Due Day              | Integer        | **Required** - Payment due day (1-31, must differ from billing day) |
| Expiry Date          | Date           | **Required** - Card expiry date (must be in future)                 |
| Opening Balance      | Decimal        | Initial balance (negative = owed amount)                            |
| Opened On            | Date           | When card was issued                                                |
| Currency             | INR (fixed)    | ‚Äî                                                                   |
| Status               | Enum           | Active / Archived                                                   |
| Notes                | Text           | Optional                                                            |
| Color                | Hex Code       | Visual customization                                                |
| Picture              | Image          | Optional card logo/picture                                          |

**Credit Card Balance Tracking:**

- Negative balance = Amount owed (liability)
- Positive balance = Overpayment (rare scenario)
- Available Credit = Credit Limit + Current Balance
  - Example: Limit ‚Çπ50,000, Balance -‚Çπ5,000 ‚Üí Available ‚Çπ45,000
- Amount Owed = Absolute value of negative balance

**Actions:**

- Add/Edit/Delete credit card
- Calculate available credit (limit + balance)
- Calculate amount owed (abs(min(balance, 0)))
- View current balance (negative = amount owed)
- View card detail & linked transactions/transfers
- Toggle card number visibility (masked ‚Üî full with spaces)
- Copy card number and CVV to clipboard
- Mask card number (show ‚Ä¢‚Ä¢‚Ä¢‚Ä¢1234)
- Display billing/due day with ordinal suffixes (1st, 2nd, 3rd, etc.)
- Toggle card status (active/archived)
- CVV field preservation in edit mode (shows ‚Ä¢‚Ä¢‚Ä¢ placeholder)

**UI Enhancements:**

- Card number auto-formatting with spaces (1234 5678 9012 3456)
- Eye icon to toggle sensitive data visibility
- Copy icon for card number and CVV
- 2 decimal places for monetary amounts
- Card type icons (Visa, Mastercard, RuPay, Amex)

**Validations:**

- Card number: 13-19 digits only
- CVV: 3-4 digits only
- Expiry date must be in future
- Credit limit must be positive
- Billing day and due day must be between 1-31
- Billing day ‚â† Due day
- Institution name preserved as entered (no title case)
- **Insufficient Balance Exemption:** Credit cards can go more negative (no balance validation on expenses)
- **Bank Account Balance Validation:** Bank accounts cannot go negative; expenses must not exceed current balance

### 4.2.4 Digital Wallets

UPI apps and mobile wallets (Google Pay, PhonePe, PayTM, Amazon Pay, etc.).

**Fields:**

| Field           | Type        | Notes                                    |
| --------------- | ----------- | ---------------------------------------- |
| Name / Nickname | Text        | Wallet display name                      |
| Wallet Type     | Enum        | UPI App / Mobile Wallet / Other          |
| Provider        | Text        | Provider name (GPay, PhonePe, etc.)      |
| Linked Mobile   | String      | Mobile number, optional                  |
| UPI ID          | String      | UPI handle (username@provider), optional |
| Opening Balance | Decimal     | Initial balance                          |
| Currency        | INR (fixed) | ‚Äî                                        |
| Opened On       | Date        | When started using                       |
| Status          | Enum        | Active / Archived                        |
| Notes           | Text        | Optional                                 |
| Color           | Hex Code    | Visual customization                     |

**Actions:**

- Add/Edit/Delete wallet
- View current balance
- View wallet detail & linked transactions

### 4.2.5 Cash Accounts

Physical cash holdings.

**Fields:**

| Field           | Type        | Notes                                  |
| --------------- | ----------- | -------------------------------------- |
| Name / Nickname | Text        | Cash account name                      |
| Cash Type       | Enum        | Physical Wallet / Cash at Home / Other |
| Location        | Text        | Where cash is kept, optional           |
| Opening Balance | Decimal     | Initial cash amount                    |
| Currency        | INR (fixed) | ‚Äî                                      |
| Status          | Enum        | Active / Archived                      |
| Notes           | Text        | Optional                               |
| Color           | Hex Code    | Visual customization                   |

**Actions:**

- Add/Edit/Delete cash account
- Track cash balance
- View cash detail & linked transactions

### 4.2.6 Fixed Deposits

Fixed deposit accounts with maturity tracking. **FDs are informational records only** - they do NOT integrate with the transaction/ledger system.

**Important Notes:**

- FDs are **standalone models** (do NOT inherit from BaseAccount)
- FDs do **NOT appear** in transaction/transfer account selection dropdowns
- Interest is entered **manually during FD creation** (maturity_amount field)
- No automatic interest calculation or posting
- No ledger integration or balance tracking
- Dashboard net worth includes maturity amounts of active FDs only

**Fields:**

| Field                 | Type      | Required | Notes                                             |
| --------------------- | --------- | -------- | ------------------------------------------------- |
| User                  | FK        | Yes      | Owner of the FD                                   |
| Name / Nickname       | Text      | Yes      | FD display name                                   |
| Institution           | Text      | Yes      | Bank name                                         |
| FD Number             | String    | No       | FD account/certificate number                     |
| Principal Amount      | Decimal   | Yes      | Deposited amount                                  |
| Interest Rate         | Decimal   | Yes      | Annual interest rate (%)                          |
| Compounding Frequency | Enum      | Yes      | Monthly / Quarterly / Annually                    |
| Tenure Months         | Integer   | Yes      | Duration in months                                |
| Opened On             | Date      | Yes      | FD start date                                     |
| Maturity Date         | Date      | Yes      | When FD matures                                   |
| Maturity Amount       | Decimal   | Yes      | Final amount (principal + interest, user-entered) |
| Auto Renewal          | Boolean   | Yes      | Auto-renew on maturity (default: False)           |
| Status                | Enum      | Yes      | active / archived                                 |
| Notes                 | Text      | No       | Optional notes                                    |
| Color                 | Hex Code  | No       | Visual customization                              |
| Created At            | Timestamp | Auto     | Record creation time                              |
| Updated At            | Timestamp | Auto     | Last update time                                  |

**Status Workflow:**

- **active**: FD is currently active and earning interest
- **archived**: FD has matured and been withdrawn (marked by user)
- Marking as matured automatically archives the FD (irreversible)
- Users can manually archive active FDs if needed

**Maturity Date Badge Behavior:**

- **Active FD (future maturity)**: "Matures in X days" (green badge)
- **Active FD (past maturity)**: "Matured X days ago" (orange badge, ready to mark)
- **Archived FD**: "Matured on DD/MM/YYYY" (gray badge)

**Actions:**

- Create FD with all details (including maturity amount)
- Edit FD details (all fields editable)
- Delete FD (with confirmation)
- Mark as Matured ‚Üí Automatically archives (one-step, irreversible)
- View FD detail page
- List view shows maturity status badges

**Validations:**

- Principal amount > 0
- Interest rate: 0-100%
- Maturity date > Opened on date
- Maturity amount ‚â• Principal amount
- Tenure months > 0

### 4.2.7 Loan Accounts

Loan tracking with EMI management.

**Fields:**

| Field               | Type        | Notes                                      |
| ------------------- | ----------- | ------------------------------------------ |
| Name / Nickname     | Text        | Loan display name                          |
| Loan Type           | Enum        | Personal / Home / Auto / Education / Other |
| Lender Name         | Text        | Lending institution                        |
| Loan Account Number | String      | Loan account number, optional              |
| Principal Amount    | Decimal     | Original loan amount                       |
| Interest Rate       | Decimal     | Annual interest rate (%)                   |
| EMI Amount          | Decimal     | Monthly EMI, optional                      |
| Tenure Months       | Integer     | Loan duration in months                    |
| EMI Day             | Integer     | Day of month for EMI (1-31), optional      |
| Start Date          | Date        | Loan start date                            |
| Opening Balance     | Decimal     | Outstanding balance (negative)             |
| Currency            | INR (fixed) | ‚Äî                                          |
| Status              | Enum        | Active / Archived                          |
| Notes               | Text        | Optional                                   |
| Color               | Hex Code    | Visual customization                       |

**Actions:**

- Add/Edit/Delete loan
- Track outstanding balance (negative value)
- View loan detail & EMI payments
- Record EMI payments via transactions
- EMI schedule view (future)
- Prepayment calculator (future)

### Common Behavior Across Transactional Account Types

**Applies to: Bank Accounts, Credit Cards, Digital Wallets, Cash Accounts, Loans**

- Archive/Activate: Soft delete with status toggle
- Balance Tracking: Materialized balance table for fast lookups (per account type)
- User Scoping: All accounts belong to a user
- Visual Customization: Color coding and optional pictures/icons
- Name Storage: Names and institutions stored as entered (no auto-capitalization)
- Timestamps: Created and updated timestamps for audit trail
- GenericForeignKey Support: All account types can be referenced in transactions and transfers

### Fixed Deposits - Special Behavior

**FDs are NOT transactional accounts:**

- **No Balance Tracking**: FDs do not have materialized balance tables
- **No GenericForeignKey**: FDs cannot be selected in transactions/transfers
- **No Ledger Integration**: FDs do not create journal entries or postings
- **Standalone Records**: FDs are informational tracking only
- **Manual Interest**: User enters maturity amount during creation
- **Status-based Workflow**: active ‚Üí archived (via "Mark as Matured" action)
- **Dashboard Integration**: Active FD maturity amounts included in net worth
- **Visual Customization**: Color coding supported, no picture uploads

### 4.2.8 Account Integration & Selection

**Combined Account Selection:**
When selecting accounts in transactions or transfers, the system provides a unified dropdown showing all account types with visual indicators.

**Dropdown Format:**

- Emoji prefix for account type identification
- Format: "[Emoji] Account Name (Institution/Type)"
- Examples:
  - "üè¶ HDFC Savings (HDFC Bank)"
  - "üí≥ HDFC Regalia (Credit Card)"
  - "üì± Google Pay (UPI Wallet)" [future]
  - "üíµ Wallet Cash (Cash)" [future]

**Emoji Indicators:**
| Emoji | Account Type | Notes |
|-------|--------------|-------|
| üè¶ | Bank Accounts | Savings, Checking, Current, Salary |
| üí≥ | Credit Cards | All credit card types |
| üì± | Digital Wallets | UPI apps, mobile wallets (future) |
| üíµ | Cash Accounts | Physical cash (future) |

**Note:** Fixed Deposits (FDs) do NOT appear in account selection dropdowns as they are informational records only, not transactional accounts.

**Technical Implementation:**

- GenericForeignKey for polymorphic account references
- Combined queryset from multiple models (BankAccount, CreditCard, etc.)
- ContentType framework for type discrimination
- Maintains referential integrity across account types

**Combined Accounts Page ("Accounts & Cards"):**

- Renamed from "Accounts" to "Accounts & Cards" in navigation
- Two distinct sections on the page:
  1. **Bank Accounts Section**
     - Header: "Bank Accounts"
     - Shows all bank accounts with üè¶ emoji
     - Stats: Total balance across all bank accounts
     - Action button: "Add Bank Account"
  2. **Credit Cards Section**
     - Header: "Credit Cards"
     - Shows all credit cards with üí≥ emoji
     - Stats: Total credit limit, available credit, amount owed
     - Action button: "Add Credit Card"
- Responsive grid layout for both sections
- Consistent styling and card design across sections

**Validations**

- Account name required.
- Account type required.
- Account number unique per user per institution.

  4.3 Transactions Module
  Description

Captures user's credits (income) and debits (expenses) per account.

**Transaction Fields**

| Field        | Type           | Description                                                  |
| ------------ | -------------- | ------------------------------------------------------------ |
| Date & Time  | Datetime (IST) | Required                                                     |
| Credit/Debit | Enum           | Credit (+) or Debit (‚àí)                                      |
| Amount       | Decimal        | Required, > 0                                                |
| Account      | GenericFK      | Polymorphic reference to Bank/Credit Card/Wallet/Cash        |
| Type         | Enum           | UPI / Card / Netbanking / Cash / Wallet / IMPS / NEFT / RTGS |
| Purpose      | Text           | Free text description                                        |
| Category     | FK             | Required (Income or Expense category)                        |
| Created By   | FK             | Auto-filled                                                  |
| Created At   | Datetime       | Auto                                                         |
| Updated At   | Datetime       | Auto                                                         |
| Deleted At   | Datetime       | Soft delete marker                                           |

**Account Selection:**

- Combined dropdown with emoji indicators (üè¶ üí≥ üì± üíµ)
- Format: "[Emoji] Account Name (Institution/Type)"
- GenericForeignKey allows selection of any account type
- Account type is automatically detected from selected account

**Credit Card Transaction Behavior:**

- **Expense on Credit Card:** Balance becomes MORE negative (debt increases)
  - Example: Balance -‚Çπ5,000, spend ‚Çπ2,000 ‚Üí New balance -‚Çπ7,000
  - Available credit decreases by ‚Çπ2,000
  - Amount owed increases by ‚Çπ2,000
- **Income on Credit Card** (cashback/refund): Balance becomes LESS negative (debt decreases)
  - Example: Balance -‚Çπ5,000, refund ‚Çπ1,000 ‚Üí New balance -‚Çπ4,000
  - Available credit increases by ‚Çπ1,000
  - Amount owed decreases by ‚Çπ1,000

Actions

Create, edit, delete (soft).

Filter/search by date, account, type, category, amount range.

Account filter includes all account types (banks + credit cards).

Pagination & sorting.

Transaction history shows on account detail pages.

Business Rules

Debit = Expense ‚Üí reduces account balance (or increases credit card debt).

Credit = Income ‚Üí increases account balance (or reduces credit card debt).

Double-entry ledger maintains balance consistency.

Posting creation:

- Income: Debit to account, Credit to Income Control
- Expense: Credit to account, Debit to Expense Control

Balance updates are atomic (select_for_update).

Validations

Amount cannot be 0.

Category required.

Credit/Debit must be selected.

Account must be selected.

Category type must match transaction type (Income category for Credit, Expense category for Debit).

Create, edit, delete (soft).

Filter/search by date, account, type, category, amount range.

Inline category editing in list.

Pagination & sorting.

Business Rules

Debit = Expense ‚Üí reduces account balance.

Credit = Income ‚Üí increases account balance.

Double-entry ledger maintains balance consistency.

Validations

Amount cannot be 0.

Category required.

Credit/Debit must be selected.

4.4 Transfers
Description

Used to move funds between user's accounts. Supports transfers between any account types including banks and credit cards.

**Fields**

| Field          | Type           | Description                                          |
| -------------- | -------------- | ---------------------------------------------------- |
| Date & Time    | Datetime (IST) | Required                                             |
| From Account   | GenericFK      | Polymorphic reference (Bank/Credit Card/Wallet/Cash) |
| To Account     | GenericFK      | Polymorphic reference (Bank/Credit Card/Wallet/Cash) |
| Amount         | Decimal        | Required, > 0                                        |
| Method         | Enum           | UPI / NEFT / IMPS / RTGS / Netbanking / Cash / Other |
| Memo / Purpose | Text           | Optional description                                 |

**Account Selection:**

- Both From Account and To Account use unified dropdown
- Emoji indicators for account types (üè¶ üí≥ üì± üíµ)
- Format: "[Emoji] Account Name (Institution/Type)"
- GenericForeignKey implementation for polymorphic references

**Supported Transfer Scenarios:**

1. üè¶ Bank ‚Üí üè¶ Bank (standard inter-account transfer)
2. üè¶ Bank ‚Üí üí≥ Credit Card (bill payment - reduces credit card debt)
3. üí≥ Credit Card ‚Üí üè¶ Bank (refund/reversal - increases credit card debt)
4. üí≥ Credit Card ‚Üí üí≥ Credit Card (balance transfer between cards)
5. üì± Wallet ‚Üí üè¶ Bank (future - wallet to bank)
6. üíµ Cash ‚Üí üè¶ Bank (future - cash deposit)
7. And all other combinations

**Credit Card Bill Payment Logic:**
When transferring FROM Bank TO Credit Card (bill payment):

- From Account (Bank): Balance decreases by transfer amount
- To Account (Credit Card): Balance becomes LESS negative (debt decreases)
- Credit card available credit increases by transfer amount

Example:

- Bank balance: ‚Çπ50,000
- Credit card balance: -‚Çπ10,000 (owe ‚Çπ10,000)
- Transfer ‚Çπ5,000 from Bank ‚Üí Credit Card
- New bank balance: ‚Çπ45,000
- New credit card balance: -‚Çπ5,000 (owe ‚Çπ5,000)
- New available credit: Credit limit - ‚Çπ5,000 (instead of credit limit - ‚Çπ10,000)

**Credit Card Refund/Reversal Logic:**
When transferring FROM Credit Card TO Bank (refund scenario):

- From Account (Credit Card): Balance becomes MORE negative (debt increases)
- To Account (Bank): Balance increases by transfer amount

Actions

Create, edit, delete (soft).

View transfer list with filter by date range, from/to account.

Transfer detail shows both account impacts.

Toggle between Transaction and Transfer views (tabs).

Pagination & sorting.

**Business Rules**

From Account ‚â† To Account (validates both ContentType ID and object ID for GenericForeignKey).

Creates two linked ledger postings:

- Debit (negative) from source account
- Credit (positive) to destination account

Journal entry links both postings.

Balance updates are atomic using select_for_update().

Displays as single "Transfer" row in UI showing directional flow.

Soft delete sets deleted_at timestamp and reverses balances.

**Validation Rules:**

- Bank accounts: Must have sufficient balance for outgoing transfers
- Credit cards: No balance validation (can go more negative)
- Same account check: Compares ContentType ID AND object ID (allows BankAccount ID=4 ‚Üí CreditCard ID=4)
- Three-layer validation: Form, Model, and Service layers must all be consistent
- User ownership: Both accounts must belong to same user
  4.5 Categories
  Description

Classify transactions for reporting and analytics.

**Fields**

| Field           | Type      | Notes                             |
| --------------- | --------- | --------------------------------- |
| Name            | Text      | e.g., Groceries                   |
| Parent Category | FK (self) | For tree hierarchy                |
| Type            | Enum      | Income / Expense / Transfer / Fee |
| Color           | Text      | Optional (for chart)              |

**Defaults (India-specific)**

- **Expense:** Groceries, Rent, Bills, Education, Travel, Fuel, Fashion, Dining, Healthcare, Entertainment, Fees & Charges.
- **Income:** Salary, Interest, Dividends, Refunds, Others.

**Actions**

- Add/Edit/Delete custom categories.
- Prevent deletion if in use (reassign option).

  4.6 Investments
  Description

Manage stocks and mutual fund investments.

**Entities**

- **Instrument:** defines the security (Stock/MF).
- **Trade:** records buy/sell/dividend/fee.
- **Holding:** derived aggregate (per instrument).

**Fields**

**Instrument**

| Field  | Type | Description         |
| ------ | ---- | ------------------- |
| Name   | Text | e.g., HDFC Bank     |
| Symbol | Text | e.g., HDFCBANK      |
| ISIN   | Text | Unique code         |
| Type   | Enum | Stock / Mutual Fund |
| Notes  | Text | Optional            |

**Trade**

| Field           | Type           | Description                  |
| --------------- | -------------- | ---------------------------- |
| Type            | Enum           | Buy / Sell / Dividend / Fees |
| Date & Time     | Datetime (IST) | ‚Äî                            |
| Instrument      | FK             | ‚Äî                            |
| Units           | Decimal        | For buy/sell                 |
| Price per Unit  | Decimal        | ‚Äî                            |
| Fees            | Decimal        | Optional                     |
| Funding Account | FK             | Cash/Bank/Wallet             |
| Purpose         | Text           | Optional                     |

**Holding**

| Field      | Type    | Description                            |
| ---------- | ------- | -------------------------------------- |
| Instrument | FK      | ‚Äî                                      |
| Units      | Decimal | Derived                                |
| Avg Cost   | Decimal | Derived                                |
| Value      | Decimal | Manual or calculated (if price exists) |

**Rules**

- FIFO lot calculation for realized P&L.
- Dividends/fees adjust holdings and income categories.
- Manual price entry screen available.

  4.7 Fixed Deposits (FDs)
  Description

Tracks user's fixed income deposits as **informational records only**. FDs do NOT integrate with transactions, transfers, or the ledger system.

**Fields**

| Field                 | Type      | Description                                              |
| --------------------- | --------- | -------------------------------------------------------- |
| User                  | FK        | Owner of the FD                                          |
| Name                  | Text      | FD display name                                          |
| Institution           | Text      | Bank name                                                |
| FD Number             | String    | FD account/certificate number (optional)                 |
| Principal Amount      | Decimal   | Deposited amount (required)                              |
| Interest Rate         | Decimal   | Annual interest rate % (required, user-entered)          |
| Compounding Frequency | Enum      | Monthly / Quarterly / Annually                           |
| Tenure Months         | Integer   | Duration in months                                       |
| Opened On             | Date      | FD start date                                            |
| Maturity Date         | Date      | When FD matures                                          |
| Maturity Amount       | Decimal   | Final amount including interest (required, user-entered) |
| Auto Renewal          | Boolean   | Auto-renew on maturity                                   |
| Status                | Enum      | active / archived                                        |
| Notes                 | Text      | Optional                                                 |
| Color                 | Hex Code  | Visual customization (optional)                          |
| Created At            | Timestamp | Auto                                                     |
| Updated At            | Timestamp | Auto                                                     |

**Behavior**

- **No Transaction Integration**: FDs do NOT appear in transaction/transfer account dropdowns
- **Manual Interest Entry**: User enters maturity amount during FD creation (no auto-calculation)
- **No Ledger Postings**: Creating/editing FDs does not create journal entries
- **Status Workflow**: Mark as Matured ‚Üí Auto-archives (irreversible)
- **Dashboard Integration**: Active FD maturity amounts included in net worth calculation
- **Maturity Tracking**: List view shows maturity status badges
- **Standalone Model**: Does NOT inherit from BaseAccount

  4.8 Loans
  Description

Stores loan details and manual EMI tracking.

**Fields**

| Field         | Type    | Description     |
| ------------- | ------- | --------------- |
| Lender Name   | Text    | ‚Äî               |
| Principal     | Decimal | ‚Äî               |
| Interest Rate | Decimal | ‚Äî               |
| EMI Amount    | Decimal | Optional        |
| Start Date    | Date    | ‚Äî               |
| Due Day       | Integer | Optional        |
| Status        | Enum    | Active / Closed |

**Behavior**

- EMI payments manually logged in Transactions.
- Optional "Record EMI" shortcut pre-fills transaction form.

  4.9 Dashboard
  **Widgets**

| Widget              | Description                                                                     |
| ------------------- | ------------------------------------------------------------------------------- |
| Net Worth           | Sum of bank account balances + investments (does NOT subtract credit card debt) |
| Total Accounts      | Count of accounts with breakdown: "X Banks ‚Ä¢ Y Cards"                           |
| Income (MTD)        | Total income for current month (all accounts)                                   |
| Expense (MTD)       | Total expense for current month (all accounts)                                  |
| Recent Transactions | Last 10 transactions (includes credit card transactions)                        |

**Dashboard Card Details:**

1. **Net Worth Card**

   - Calculation: Sum of all bank account balances + investment values
   - Uses `get_current_balance()` method which falls back to opening_balance if balance record missing
   - Does NOT subtract credit card debt (debt is tracked separately)
   - Shows in Indian number format without decimals (e.g., ‚Çπ10,63,833)
   - Non-clickable (informational only)

2. **Total Accounts Card**
   - Shows breakdown: "X Banks ‚Ä¢ Y Cards"
   - Example: "5 Accounts" with subtitle "3 Banks ‚Ä¢ 2 Cards"
   - Clickable - links to "Accounts & Cards" page
   - Updates when accounts are added/archived

**Number Formatting:**

- **Indian Format:** All amounts displayed in Indian numbering system (X,XX,XXX)
- **Dashboard Stats:** Net Worth, Income, Expense shown as integers (no decimals) for clean display
- **Transaction Amounts:** Shown with 2 decimal places for precision
- **Balance Displays:** Context-dependent (integers for summaries, decimals for details)
- **Custom Template Filter:** `indian_format` with optional decimals parameter
  - Usage: `{{ value|indian_format:0 }}` for integers
  - Usage: `{{ value|indian_format }}` or `{{ value|indian_format:2 }}` for decimals

3. **Recent Transactions Section**
   - Shows last 10 transactions across ALL account types
   - Includes both bank and credit card transactions
   - Shows account name with emoji indicator
   - Date, category, purpose, and amount
   - Link to full transaction list

**Balance Calculation Robustness:**

- **Materialized Balance Tables:** Separate tables for bank and credit card balances
- **Balance Caching:** `bank_account_balances` and `credit_card_balances` cache current balances
- **Calculation Method:** `opening_balance + SUM(postings)` = current balance
- **Fallback Mechanism:** `get_current_balance()` method returns opening_balance if balance record missing
- **Dashboard & List Pages:** Use `get_current_balance()` instead of direct database aggregation
- **Graceful Degradation:** System continues to function even if balance records are deleted
- **Recalculation Command:** `python manage.py recalculate_balances` to rebuild balance records from ledger

**Quick Actions:**

- **Add Account** button ‚Üí Shows choice modal with options:
  - "Add Bank Account" ‚Üí Links to bank account create form
  - "Add Credit Card" ‚Üí Links to credit card create form
- **Record Transaction** button ‚Üí Links to transaction create form
- **Transfer Money** button ‚Üí Links to transfer create form

**Choice Modal Design:**

- Appears as overlay/modal when "Add Account" clicked
- Two large buttons with icons:
  - üè¶ Add Bank Account
  - üí≥ Add Credit Card
- Cancel/close option
- Responsive design for mobile

**Credit Card Integration:**

- Credit card transactions appear in Recent Transactions
- Account filters include credit cards
- Emoji indicators differentiate account types
- Net Worth intentionally excludes credit card debt (per user requirement)
  4.10 Reports
  | Report | Description |
  |--------|-------------|
  | Net Worth Over Time | Line chart, monthly aggregation |
  | Spend by Category | Donut + tabular |
  | Income vs Expense | Monthly bar |
  | Account Balances | Table |
  | Holdings Snapshot | Cost/current summary |

All reports have filter panels (date range, account, type, category).

4.11 Activity Log

Tracks CRUD actions.

| Field          | Type           | Description                        |
| -------------- | -------------- | ---------------------------------- |
| User           | FK             | ‚Äî                                  |
| Action         | Enum           | Create / Update / Delete           |
| Object Type    | Text           | Transaction / Account / Investment |
| Object ID      | Integer        | ‚Äî                                  |
| Timestamp      | Datetime (IST) | ‚Äî                                  |
| IP Address     | String         | ‚Äî                                  |
| Change Summary | JSON/Text      | Field diffs                        |

4.12 Settings
**Profile**

- Name (editable)
- Email (readonly)
- Theme toggle (Dark/Light)
- Date format (fixed display)
- Timezone (fixed IST)

**Security**

- Change Password
- Session list with IP & device
- Log out all sessions

**Preferences**

- Masking behavior toggle
- Default landing page
- Default filters

5. Non-Functional Requirements
   | Category | Description |
   |----------|-------------|
   | Performance | Must handle 10K transactions per user smoothly. Indexed queries on transaction & account tables. |
   | Security | Hashed passwords, CSRF & session protection, masked data in UI. |
   | Reliability | Auto reconnect to DB, soft deletes for safety. |
   | Scalability | Modular Django apps for easy scaling later (Celery, Redis to be added in V2). |
   | Backup | Managed externally (pg_dump). |
   | Time zone | Store & display in IST. |
   | UI/UX | Minimalist dark theme with optional light mode. Indian number formatting (X,XX,XXX) with configurable decimals. |
   | Compliance | No storage of full card/bank numbers. |
   | Extensibility | Hooks for future import/export, ML categorization, APIs. |

6. Error Handling
   | Scenario | User Feedback |
   |----------|---------------|
   | Missing required field | Inline red message below field. |
   | Invalid amount | "Amount must be greater than zero." |
   | Duplicate account number | "This account already exists." |
   | Transfer from and to same account | "Cannot transfer between the same account." |
   | Unauthorized access | Redirect to login. |
   | Server errors | Toast "Something went wrong. Try again." |
   | Validation success | Toast "Saved successfully." |

7. Audit & Logging

Log every create/update/delete of key models.

**Capture:**

- User ID
- Object Type & ID
- Action
- Timestamp (IST)
- IP Address
- Changed Fields (diff JSON)

Exposed through Activity Log page.

8. Future (V2+) Extensibility Hooks
   | Planned Module | Description |
   |----------------|-------------|
   | Import/Export | CSV & API import/export. |
   | Budgeting | Monthly budgets & category limits. |
   | Capital Gains | LTCG/STCG tracking for investments. |
   | Auto Price Fetch | AMFI/NSE feeds. |
   | Email Flows | Verification & password reset. |
   | 2FA | TOTP-based. |
   | ML Categorization | Auto-suggest categories. |
   | Notifications | Bill due, balance low, etc. |

9. Data Flow Summary

**Example: Add Transaction**

User fills form ‚Üí Validates input.

Django view receives payload.

Creates transaction record.

Creates journal entry with balanced postings.

Updates account balance cache.

Activity log created.

UI shows success toast & refreshed list.

**Example: Transfer**

User fills "Transfer" modal.

System creates two linked postings (debit/credit).

Ledger validates zero-sum.

Activity log created.

Dashboard recalculates balances.

10. Data Model (simplified functional schema)
    User ‚îÄ‚î¨‚îÄ< Account ‚îÄ‚î¨‚îÄ< Transaction
    ‚îÇ ‚îî‚îÄ< Transfer
    ‚îú‚îÄ< Category
    ‚îú‚îÄ< Instrument ‚îÄ‚î¨‚îÄ< Trade ‚îÄ‚î¨‚îÄ< Holding
    ‚îÇ ‚îÇ ‚îî‚îÄ< Price
    ‚îú‚îÄ< FD
    ‚îú‚îÄ< Loan
    ‚îî‚îÄ< ActivityLog

11. UI States

- **Loading:** subtle skeleton shimmer.
- **Success:** toast ("Saved!").
- **Error:** toast with retry link.
- **Empty:** illustrated state + CTA.
- **Dark/Light toggle:** persist in session & profile.

12. Security and Privacy

- Passwords hashed (Argon2/Bcrypt).
- CSRF tokens for all POST requests.
- Mask sensitive fields by default.
- Strict user-level query scoping.
- HTTPS-ready (through reverse proxy).
- Audit trail for every modification.

13. Deployment Plan

**Docker Compose services:**

- web: Django app (Gunicorn).
- db: PostgreSQL 16.
- proxy: Nginx/Caddy (optional, local use).

**Volumes:**

- /db_data ‚Üí Postgres persistent data.
- /media ‚Üí user-uploaded receipts (future).

14. Testing & Validation

**Phase 3F: Comprehensive Integration Testing (Completed)**

A detailed integration test plan was executed to validate credit card integration across the entire application. The test plan covered:

- **8 Test Suites:**

  1. Transaction Tests (income/expense on credit cards)
  2. Transfer Tests (bank‚Üîcredit card, credit card‚Üîcredit card)
  3. Dashboard Tests (stats, recent transactions, modals)
  4. Accounts & Cards Page Tests (combined view, responsive design)
  5. Account Detail Pages (transaction/transfer history)
  6. Deletion Protection (prevent deletion with dependencies)
  7. Balance Recalculation (ledger integrity verification)
  8. Edge Cases (overpayment, decimals, large numbers)

- **Key Findings & Fixes:**

  - Fixed transfer validation to properly compare GenericForeignKey accounts (ContentType + ID)
  - Fixed balance calculations in dashboard and account list to use `get_current_balance()`
  - Added insufficient balance validation for bank accounts (exempt credit cards)
  - Verified Indian number formatting across all pages
  - Confirmed balance recalculation command works correctly

- **Test Results:**
  - All test suites passed ‚úì
  - All journal entries balanced to zero ‚úì
  - No orphaned journal entries ‚úì
  - Balance integrity verified ‚úì
  - Decimal precision maintained (2 decimal places) ‚úì

For complete test plan, see: `PHASE_3F_TEST_PLAN.md`

15. Acceptance Criteria Summary
    | Module | Acceptance Criteria |
    |--------|---------------------|
    | Auth | User can sign up, log in/out; session persists. |
    | Accounts | User can add/edit/delete accounts; balances computed correctly. |
    | Transactions | User can log credits/debits with correct UI flow. |
    | Transfers | Creates two linked entries; balances update. |
    | Categories | Default tree exists; editable by user. |
    | Investments | User can record trades; holdings aggregate properly. |
    | FDs | User can store FD details. |
    | Loans | User can store loan details and record EMI transactions. |
    | Dashboard | Displays correct totals and charts. |
    | Reports | Generate correct filtered reports. |
    | Activity Log | Shows all user actions with correct metadata. |
