{% extends 'base/base.html' %}
{% load static %}

{% block title %}Credit Cards - Financio{% endblock %}

{% block content %}
<div class="relative flex h-auto min-h-screen w-full flex-col bg-white dark:bg-dark-bg overflow-x-hidden">
    <div class="layout-container flex h-full grow flex-col">
        {% include 'includes/header.html' %}
        {% include 'includes/sidebar.html' %}
        
        <!-- Main Content -->
        <div class="flex-1 overflow-y-auto px-4 md:px-10 py-5">
            <div class="max-w-6xl mx-auto">
                <!-- Header with Create Button -->
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                    <div>
                        <h1 class="text-gray-900 dark:text-white text-2xl md:text-3xl font-bold leading-tight">Credit Cards</h1>
                        <p class="text-gray-600 dark:text-gray-400 text-sm mt-1">
                            {{ active_count }} active • {{ archived_count}} archived • ₹{{ total_owed|floatformat:2 }} owed
                        </p>
                    </div>
                    <a href="{% url 'creditcard_create' %}" class="flex items-center justify-center px-6 py-3 rounded-lg bg-primary hover:bg-primary-hover text-white text-sm font-bold transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Add Credit Card
                    </a>
                </div>

                <!-- Messages -->
                {% if messages %}
                <div class="mb-6">
                    {% for message in messages %}
                    <div class="rounded-lg p-4 mb-2 {% if message.tags == 'error' %}bg-red-100 dark:bg-red-900/20 text-red-800 dark:text-red-200{% elif message.tags == 'success' %}bg-green-100 dark:bg-green-900/20 text-green-800 dark:text-green-200{% else %}bg-blue-100 dark:bg-blue-900/20 text-blue-800 dark:text-blue-200{% endif %}">
                        {{ message|capfirst }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Stats Cards -->
                {% if creditcards %}
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white dark:bg-dark-surface rounded-lg border border-gray-200 dark:border-gray-700 p-4">
                        <p class="text-gray-600 dark:text-gray-400 text-sm">Total Credit Limit</p>
                        <p class="text-gray-900 dark:text-white text-2xl font-bold">₹{{ total_credit_limit|floatformat:0 }}</p>
                    </div>
                    <div class="bg-white dark:bg-dark-surface rounded-lg border border-gray-200 dark:border-gray-700 p-4">
                        <p class="text-gray-600 dark:text-gray-400 text-sm">Available Credit</p>
                        <p class="text-green-600 dark:text-green-400 text-2xl font-bold">₹{{ total_available_credit|floatformat:2 }}</p>
                    </div>
                    <div class="bg-white dark:bg-dark-surface rounded-lg border border-gray-200 dark:border-gray-700 p-4">
                        <p class="text-gray-600 dark:text-gray-400 text-sm">Amount Owed</p>
                        <p class="text-red-600 dark:text-red-400 text-2xl font-bold">₹{{ total_owed|floatformat:2 }}</p>
                    </div>
                </div>
                {% endif %}

                <!-- Credit Cards Grid -->
                {% if creditcards %}
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {% for card in creditcards %}
                        <div class="bg-white dark:bg-dark-surface rounded-lg border border-gray-200 dark:border-gray-700 p-5 hover:shadow-lg transition-shadow {% if card.status == 'archived' %}opacity-60{% endif %}">
                            <!-- Card Header -->
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center gap-3 flex-1 min-w-0">
                                    {% if card.picture %}
                                    <img src="{{ card.picture.url }}" alt="{{ card.name }}" class="w-12 h-12 rounded-lg object-cover flex-shrink-0">
                                    {% else %}
                                    <div class="flex items-center justify-center rounded-lg flex-shrink-0 w-12 h-12" style="background-color: {{ card.color|default:'#6366f1' }};">
                                        <span class="text-white font-bold text-lg">{{ card.name|slice:":1"|upper }}</span>
                                    </div>
                                    {% endif %}
                                    <div class="flex-1 min-w-0">
                                        <h3 class="text-gray-900 dark:text-white font-semibold truncate">{{ card.name }}</h3>
                                        <p class="text-gray-500 dark:text-gray-400 text-sm">{{ card.get_card_type_display }} •• {{ card.card_number_last4 }}</p>
                                    </div>
                                </div>
                                <div class="relative flex-shrink-0 ml-2">
                                    <button onclick="toggleMenu('menu-{{ card.id }}')" class="p-2 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
                                        </svg>
                                    </button>
                                    <div id="menu-{{ card.id }}" class="hidden absolute right-0 mt-1 w-48 bg-white dark:bg-dark-surface rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 py-1 z-10">
                                        <a href="{% url 'creditcard_detail' card.pk %}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">View Details</a>
                                        <a href="{% url 'creditcard_edit' card.pk %}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Edit</a>
                                        <a href="{% url 'creditcard_toggle_status' card.pk %}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                            {% if card.status == 'active' %}Archive{% else %}Activate{% endif %}
                                        </a>
                                        <a href="{% url 'creditcard_delete' card.pk %}" class="block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20">Delete</a>
                                    </div>
                                </div>
                            </div>

                            <!-- Card Details -->
                            <div class="space-y-2 mb-4">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-gray-600 dark:text-gray-400">Institution</span>
                                    <span class="text-gray-900 dark:text-white font-medium">{{ card.institution }}</span>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-gray-600 dark:text-gray-400">Credit Limit</span>
                                    <span class="text-gray-900 dark:text-white font-medium">₹{{ card.credit_limit|floatformat:0 }}</span>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-gray-600 dark:text-gray-400">Available</span>
                                    <span class="text-green-600 dark:text-green-400 font-medium">₹{{ card.available_credit|floatformat:2 }}</span>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-gray-600 dark:text-gray-400">Amount Owed</span>
                                    <span class="text-red-600 dark:text-red-400 font-medium">₹{{ card.amount_owed|floatformat:2 }}</span>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-gray-600 dark:text-gray-400">Expiry</span>
                                    <span class="text-gray-900 dark:text-white font-medium">{{ card.expiry_date|date:"m/y" }}</span>
                                </div>
                            </div>

                            <!-- Action Button -->
                            <a href="{% url 'creditcard_detail' card.pk %}" class="block w-full text-center px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-sm font-medium">
                                View Details
                            </a>

                            <!-- Status Badge -->
                            {% if card.status == 'archived' %}
                            <div class="mt-3 text-center">
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
                                    Archived
                                </span>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="bg-white dark:bg-dark-surface rounded-lg border border-gray-200 dark:border-gray-700 p-12 text-center">
                        <svg class="mx-auto h-16 w-16 text-gray-400 dark:text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                        </svg>
                        <h3 class="text-gray-900 dark:text-white text-lg font-semibold mb-2">No credit cards yet</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-6">Get started by adding your first credit card</p>
                        <a href="{% url 'creditcard_create' %}" class="inline-flex items-center px-6 py-3 rounded-lg bg-primary hover:bg-primary-hover text-white text-sm font-bold transition-colors">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Add Your First Card
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function toggleMenu(menuId) {
    const menu = document.getElementById(menuId);
    const allMenus = document.querySelectorAll('[id^="menu-"]');
    allMenus.forEach(m => {
        if (m.id !== menuId) m.classList.add('hidden');
    });
    menu.classList.toggle('hidden');
}

// Close menus when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('[onclick^="toggleMenu"]')) {
        document.querySelectorAll('[id^="menu-"]').forEach(m => m.classList.add('hidden'));
    }
});
</script>
{% endblock %}
